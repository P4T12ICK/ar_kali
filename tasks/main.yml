---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Install TigerVNC packages
  apt:
    name:
      - tigervnc-standalone-server
      - tigervnc-common
    state: present
  become: yes

- name: Get target user home directory
  shell: |
    getent passwd "{{ ansible_user | default(ansible_env.USER) }}" | cut -d: -f6
  register: target_user_home
  changed_when: false

- name: Create .vnc directory
  file:
    path: "{{ target_user_home.stdout }}/.vnc"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Set VNC password
  shell: |
    printf '%s\n%s\nn\n' "{{ ar_kali_password }}" "{{ ar_kali_password }}" | vncpasswd
  args:
    creates: "{{ target_user_home.stdout }}/.vnc/passwd"
  become_user: "{{ ansible_user | default(ansible_env.USER) }}"
  environment:
    HOME: "{{ target_user_home.stdout }}"
  no_log: true

- name: Create VNC xstartup script
  copy:
    dest: "{{ target_user_home.stdout }}/.vnc/xstartup"
    content: |
      #!/bin/sh
      unset SESSION_MANAGER
      unset DBUS_SESSION_BUS_ADDRESS
      [ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
      [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
      x-window-manager &
      # Try to start a desktop environment
      if command -v startxfce4 > /dev/null; then
        startxfce4 &
      elif command -v gnome-session > /dev/null; then
        gnome-session &
      elif command -v startlxde > /dev/null; then
        startlxde &
      else
        # Fallback to a basic window manager
        xterm &
      fi
    mode: '0755'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Check if VNC server is running
  stat:
    path: "{{ target_user_home.stdout }}/.vnc/{{ ansible_hostname }}:{{ ar_kali_vnc_display }}.pid"
  register: vnc_pid_file

- name: Kill existing VNC server on display {{ ar_kali_vnc_display }}
  shell: vncserver -kill :{{ ar_kali_vnc_display }}
  become_user: "{{ ansible_user | default(ansible_env.USER) }}"
  environment:
    HOME: "{{ target_user_home.stdout }}"
  when: vnc_pid_file.stat.exists
  ignore_errors: yes
  changed_when: vnc_pid_file.stat.exists

- name: Start VNC server
  shell: vncserver :{{ ar_kali_vnc_display }} -geometry {{ ar_kali_vnc_resolution }} -depth 24
  become_user: "{{ ansible_user | default(ansible_env.USER) }}"
  environment:
    HOME: "{{ target_user_home.stdout }}"
  register: vnc_start_result
  changed_when: "'already in use' not in vnc_start_result.stderr | default('')"
