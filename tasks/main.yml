---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Install TigerVNC packages
  apt:
    name:
      - tigervnc-standalone-server
      - tigervnc-common
    state: present
  become: yes

- name: Install desktop environment and X11 utilities
  apt:
    name:
      - xfce4
      - xfce4-goodies
      - xterm
      - dbus-x11
    state: present
  become: yes

- name: Get target user home directory
  shell: |
    getent passwd "{{ ansible_user | default(ansible_env.USER) }}" | cut -d: -f6
  register: target_user_home
  changed_when: false

- name: Create .vnc directory
  file:
    path: "{{ target_user_home.stdout }}/.vnc"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Create .config/tigervnc directory
  file:
    path: "{{ target_user_home.stdout }}/.config/tigervnc"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Set VNC password
  shell: |
    printf '%s\n%s\nn\n' "{{ ar_kali_password }}" "{{ ar_kali_password }}" | vncpasswd
  become_user: "{{ ansible_user | default(ansible_env.USER) }}"
  environment:
    HOME: "{{ target_user_home.stdout }}"
  args:
    creates: "{{ target_user_home.stdout }}/.vnc/passwd"
  no_log: true
  register: vnc_passwd_result

- name: Ensure VNC password file exists
  stat:
    path: "{{ target_user_home.stdout }}/.vnc/passwd"
  register: vnc_passwd_file

- name: Copy VNC password to TigerVNC location
  copy:
    src: "{{ target_user_home.stdout }}/.vnc/passwd"
    dest: "{{ target_user_home.stdout }}/.config/tigervnc/passwd"
    remote_src: yes
    mode: '0600'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"
  when: vnc_passwd_file.stat.exists

- name: Create .Xauthority file
  file:
    path: "{{ target_user_home.stdout }}/.Xauthority"
    state: touch
    mode: '0600'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Create VNC xstartup script
  copy:
    dest: "{{ target_user_home.stdout }}/.config/tigervnc/xstartup"
    content: |
      #!/bin/bash
      unset SESSION_MANAGER
      unset DBUS_SESSION_BUS_ADDRESS
      [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
      # Start XFCE4 desktop environment
      if command -v startxfce4 > /dev/null; then
        startxfce4 &
      else
        # Fallback to a basic session
        if command -v xfce4-session > /dev/null; then
          xfce4-session &
        elif command -v gnome-session > /dev/null; then
          gnome-session &
        else
          # Last resort: start a terminal
          xterm &
        fi
      fi
    mode: '0755'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Check if VNC server is running
  stat:
    path: "{{ target_user_home.stdout }}/.config/tigervnc/{{ ansible_hostname }}:{{ ar_kali_vnc_display }}.pid"
  register: vnc_pid_file
  ignore_errors: yes

- name: Check if VNC server process is running
  shell: pgrep -f "Xtigervnc.*:{{ ar_kali_vnc_display }}" || true
  register: vnc_process_check
  changed_when: false

- name: Kill existing VNC server on display {{ ar_kali_vnc_display }}
  shell: vncserver -kill :{{ ar_kali_vnc_display }}
  become_user: "{{ ansible_user | default(ansible_env.USER) }}"
  environment:
    HOME: "{{ target_user_home.stdout }}"
  when: vnc_process_check.stdout != ""
  ignore_errors: yes
  changed_when: vnc_process_check.stdout != ""

- name: Start VNC server
  shell: vncserver :{{ ar_kali_vnc_display }} -geometry {{ ar_kali_vnc_resolution }} -depth 24
  become_user: "{{ ansible_user | default(ansible_env.USER) }}"
  environment:
    HOME: "{{ target_user_home.stdout }}"
    DISPLAY: ":{{ ar_kali_vnc_display }}"
  register: vnc_start_result
  failed_when: 
    - vnc_start_result.rc != 0
    - "'already in use' not in vnc_start_result.stderr | default('')"
    - "'New Xtigervnc server' not in vnc_start_result.stdout | default('')"
  changed_when: "'New Xtigervnc server' in vnc_start_result.stdout | default('')"
