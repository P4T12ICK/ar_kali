---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Install TigerVNC packages
  apt:
    name:
      - tigervnc-standalone-server
      - tigervnc-common
    state: present
  become: yes

- name: Install desktop environment and X11 utilities
  apt:
    name:
      - xfce4
      - xfce4-goodies
      - xfce4-session
      - xterm
      - dbus-x11
      - twm
    state: present
  become: yes

- name: Get target user home directory
  shell: |
    getent passwd "{{ ansible_user | default(ansible_env.USER) }}" | cut -d: -f6
  register: target_user_home
  changed_when: false

- name: Create .vnc directory
  file:
    path: "{{ target_user_home.stdout }}/.vnc"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Create .config/tigervnc directory
  file:
    path: "{{ target_user_home.stdout }}/.config/tigervnc"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Set VNC password
  shell: |
    printf '%s\n%s\nn\n' "{{ ar_kali_password }}" "{{ ar_kali_password }}" | vncpasswd
  become_user: "{{ ansible_user | default(ansible_env.USER) }}"
  environment:
    HOME: "{{ target_user_home.stdout }}"
  args:
    creates: "{{ target_user_home.stdout }}/.vnc/passwd"
  no_log: true
  register: vnc_passwd_result

- name: Ensure VNC password file exists
  stat:
    path: "{{ target_user_home.stdout }}/.vnc/passwd"
  register: vnc_passwd_file

- name: Copy VNC password to TigerVNC location
  copy:
    src: "{{ target_user_home.stdout }}/.vnc/passwd"
    dest: "{{ target_user_home.stdout }}/.config/tigervnc/passwd"
    remote_src: yes
    mode: '0600'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"
  when: vnc_passwd_file.stat.exists

- name: Create .Xauthority file
  file:
    path: "{{ target_user_home.stdout }}/.Xauthority"
    state: touch
    mode: '0600'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Create VNC xstartup script
  copy:
    dest: "{{ target_user_home.stdout }}/.config/tigervnc/xstartup"
    content: |
      #!/bin/bash
      # Unset problematic environment variables
      unset SESSION_MANAGER
      unset DBUS_SESSION_BUS_ADDRESS
      
      # Load X resources
      [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
      
      # Start DBUS session
      if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
        eval $(dbus-launch --sh-syntax --exit-with-session)
      fi
      
      # Start a window manager in the background
      if command -v xfwm4 > /dev/null; then
        xfwm4 --replace --sm-client-disable &
      elif command -v twm > /dev/null; then
        twm &
      fi
      
      # Start XFCE4 session (exec replaces this shell process)
      if command -v xfce4-session > /dev/null; then
        exec xfce4-session
      elif command -v startxfce4 > /dev/null; then
        exec startxfce4
      elif command -v gnome-session > /dev/null; then
        exec gnome-session
      else
        # Last resort: keep a terminal running
        exec xterm
      fi
    mode: '0755'
    owner: "{{ ansible_user | default(ansible_env.USER) }}"
    group: "{{ ansible_user | default(ansible_env.USER) }}"

- name: Check if VNC server is running
  stat:
    path: "{{ target_user_home.stdout }}/.config/tigervnc/{{ ansible_hostname }}:{{ ar_kali_vnc_display }}.pid"
  register: vnc_pid_file
  ignore_errors: yes

- name: Check if VNC server process is running
  shell: pgrep -f "Xtigervnc.*:{{ ar_kali_vnc_display }}" || true
  register: vnc_process_check
  changed_when: false

- name: Kill existing VNC server on display {{ ar_kali_vnc_display }}
  shell: vncserver -kill :{{ ar_kali_vnc_display }}
  become_user: "{{ ansible_user | default(ansible_env.USER) }}"
  environment:
    HOME: "{{ target_user_home.stdout }}"
  when: vnc_process_check.stdout != ""
  ignore_errors: yes
  changed_when: vnc_process_check.stdout != ""

- name: Copy VNC server manager script
  copy:
    src: files/vnc-server-manager.sh
    dest: /usr/local/bin/vnc-server-manager.sh
    mode: '0755'
    owner: root
    group: root

- name: Start VNC server using manager script
  shell: /usr/local/bin/vnc-server-manager.sh "{{ ansible_user | default(ansible_env.USER) }}" "{{ ar_kali_vnc_display }}" "{{ ar_kali_vnc_resolution }}"
  register: vnc_start_result
  changed_when: "'already running' not in vnc_start_result.stdout | default('')"
  failed_when: 
    - vnc_start_result.rc != 0
    - "'already running' not in vnc_start_result.stdout | default('')"
    - "'started successfully' not in vnc_start_result.stdout | default('')"
  async: 30
  poll: 5

- name: Verify VNC server is running
  shell: pgrep -f "Xtigervnc.*:{{ ar_kali_vnc_display }}" || (echo "VNC not running" && exit 1)
  register: vnc_verify
  changed_when: false
  failed_when: vnc_verify.rc != 0

- name: Create systemd service for VNC server
  copy:
    dest: /etc/systemd/system/vnc-server.service
    content: |
      [Unit]
      Description=VNC Server Manager
      After=network.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/vnc-server-manager.sh {{ ansible_user | default(ansible_env.USER) }} {{ ar_kali_vnc_display }} {{ ar_kali_vnc_resolution }}
      RemainAfterExit=yes
      User=root
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target
    mode: '0644'
    owner: root
    group: root

- name: Create systemd timer for VNC server monitoring
  copy:
    dest: /etc/systemd/system/vnc-server-monitor.timer
    content: |
      [Unit]
      Description=Run VNC Server Manager every 5 minutes
      Requires=vnc-server.service

      [Timer]
      OnBootSec=5min
      OnUnitActiveSec=5min
      Unit=vnc-server.service

      [Install]
      WantedBy=timers.target
    mode: '0644'
    owner: root
    group: root

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes

- name: Enable and start VNC server service
  systemd:
    name: vnc-server.service
    enabled: yes
    state: started
  become: yes
  register: vnc_service_start

- name: Wait for VNC server to be ready
  wait_for:
    port: "{{ 5900 + ar_kali_vnc_display | int }}"
    host: "{{ ansible_default_ipv4.address | default('127.0.0.1') }}"
    delay: 5
    timeout: 30
  when: vnc_service_start.changed or vnc_service_start.state == 'started'
  ignore_errors: yes

- name: Final verification that VNC server is running
  shell: |
    if pgrep -f "Xtigervnc.*:{{ ar_kali_vnc_display }}" > /dev/null; then
      echo "VNC server is running"
      exit 0
    else
      echo "VNC server is NOT running - attempting manual start"
      /usr/local/bin/vnc-server-manager.sh "{{ ansible_user | default(ansible_env.USER) }}" "{{ ar_kali_vnc_display }}" "{{ ar_kali_vnc_resolution }}"
      sleep 3
      if pgrep -f "Xtigervnc.*:{{ ar_kali_vnc_display }}" > /dev/null; then
        echo "VNC server started successfully"
        exit 0
      else
        echo "ERROR: VNC server failed to start"
        exit 1
      fi
    fi
  register: vnc_final_check
  changed_when: "'started successfully' in vnc_final_check.stdout"
  failed_when: "'ERROR' in vnc_final_check.stdout"

- name: Enable and start VNC server monitor timer
  systemd:
    name: vnc-server-monitor.timer
    enabled: yes
    state: started
  become: yes
